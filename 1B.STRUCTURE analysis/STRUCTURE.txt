Tested STRUCTURE analysis on vcf from GATK 1A.Assembly_scripts 
Also after 1A.GWAS_scripts, 1A.bcftools_filter_beans.sh

Found that STRUCTURE could not cope with same number of SNPs and ADMIXTURE 


1/ Filtering vcfs to reduce number of SNPs for STRUCTURE


### Would not filter for heterozygosity like this again
JSON to vcf difficult

Filter for heterozygosity 0.2 in TASSEL
From Number of sites: 8989226 to Number of sites: 8185893

ON Terminal MAC
In one drive
brew install dasel 
dasel -r json -w plain < All_Andean_Haplotypecaller_filtered_maxhetero_0.2_PositionList.json | sed 's/ map/\n/g' > All_Andean_Haplotypecaller_filtered_maxhetero_0.2_PositionList5_plain.csv

brew install coreutils 
#randomly shuffle 10 lines from a file 
shuf -n 10 All_Andean_Haplotypecaller_filtered_maxhetero_0.2_PositionList5_table.csv
Open in excel and can convert scientific notation to numbers 

Split files for excel 
split -l 1000000 All_Andean_Haplotypecaller_filtered_maxhetero_0.2_PositionList5_table.csv Split.files.txt
find -name "*.fq.gz"|sort| cut -d / -f2 > All_RNA_samples.txt

#Change to tab at the end
cat Split.files.a.csv | cut -d ',' -f 17,19 | cut -d ':' -f 3- | cut -d '.' -f 1 | sed 's/],/\t/' > Split.files.a2.tsv
#Join files together
cat Split.files.*.csv > joined_files.csv
#Change to tab at the end
cat joined_files.csv | cut -d ',' -f 17,19 | cut -d ':' -f 3- | cut -d '.' -f 1 | sed 's/],/\t/' > joined_file_positionlist_max_hetero_0.2.tsv
#Keep as comma
#cat joined_files.csv | cut -d ',' -f 17,19 | cut -d ':' -f 3- | cut -d '.' -f 1 | sed 's/]/ /' > #joined_file_positionlist_max_hetero_0.2_comma.csv

#Remove row 1 as was a title from excel
sed '1d' joined_file_positionlist_max_hetero_0.2.tsv > joined_file2_positionlist_max_hetero_0.2.tsv
#sed '1d' joined_file_positionlist_max_hetero_0.2_comma.csv > joined_file2_positionlist_max_hetero_0.2_comma.csv
# Add Chr to chromosomes
awk '$1="Chr"$1' joined_file2_positionlist_max_hetero_0.2.tsv > joined_file3_positionlist_max_hetero_0.2.tsv
#Remove rows with commas (from editing with excel added commas in certain rows)
#grep '[^,]' joined_file2_positionlist_max_hetero_0.2.txt > joined_file4_positionlist_max_hetero_0.2.tsv
#sed 's/,//g' joined_file2_positionlist_max_hetero_0.2.txt > joined_file4_positionlist_max_hetero_0.2.txt
#sed '/','/d' joined_file2_positionlist_max_hetero_0.2.txt > joined_file4_positionlist_max_hetero_0.2.txt

#sbatch -p ei-long -c 1 -N 1 --wrap "source bcftools-1.12; bcftools view -R joined_file4_positionlist_max_hetero_0.2.txt --include #All_Andean_Haplotypecaller_filtered.vcf.gz -o #All_Andean_Haplotypecaller_filtered_maxhetero_0.2.vcf.gz"

sbatch -p ei-long -c 1 -N 1 -J vcftools --wrap "source vcftools-0.1.16_ge; vcftools --vcf All_Andean_Haplotypecaller_filtered.vcf --out All_Andean_Haplotypecaller_filtered_maxhetero_0.2.vcf --recode --positions joined_file3_positionlist_max_hetero_0.2.tsv"

## index file

sbatch -J bgzip --mem 20G -c 1 -N 1 -p ei-medium -t 2-0 --wrap "source vcftools-0.1.13;bgzip All_Andean_Haplotypecaller_filtered_maxhetero_0.2.vcf.recode.vcf" 
sbatch -J index --mem 20G -c 1 -N 1 -p ei-medium -t 2-0 --wrap "source bcftools-1.2;bcftools index -t All_Andean_Haplotypecaller_filtered_maxhetero_0.2.vcf.recode.vcf.gz" 

# add ID field to vcf so can get LD pruned sites
sbatch -J bcftools --mem 20G -c 1 -N 1 -p ei-medium --wrap "source bcftools-1.3.1;bcftools annotate --set-id +'%CHROM\_%POS' All_Andean_Haplotypecaller_filtered_maxhetero_0.2.vcf.recode.vcf.gz > Andean_Haplotypecaller_filtered_maxhetero0.2_ID.vcf.gz"

ln -s /hpc-home/denning/KDJ_data/Beans/GATK_vcfs/All_Andean_Haplotypecaller_filtered.vcf.gz ./
sbatch -J index --mem 20G -c 1 -N 1 -p ei-medium -t 2-0 --wrap "source bcftools-1.2;bcftools index -t All_Andean_Haplotypecaller_filtered.vcf.gz"

# add ID field to vcf so can get LD pruned sites
sbatch -J bcftools --mem 20G -c 1 -N 1 -p ei-medium --wrap "source bcftools-1.3.1;bcftools annotate --set-id +'%CHROM\_%POS' All_Andean_Haplotypecaller_filtered.vcf.gz > All_Andean_Haplotypecaller_filtered.ID.vcf.gz"



Filter for LD
sbatch -J bcftools --mem 30G -c 1 -N 1 -p ei-medium --wrap "source bcftools-1.10.2;bcftools +prune -l 0.5 -w 1000 Andean_Haplotypecaller_filtered_maxhetero0.2_ID.vcf.gz -Oz -o Andean_Haplotypecaller_filtered_maxhetero0.2_ID_LD-0.5.vcf.gz"

#rune and thin by window size
sbatch -J bcftools --mem 30G -c 1 -N 1 -p ei-medium --wrap "source bcftools-1.10.2;bcftools +prune -w 30 -n 1 Andean_Haplotypecaller_filtered_maxhetero0.2_ID_LD-0.5.vcf.gz -Oz -o Andean_Haplotypecaller_filtered_maxhetero0.2_ID_LD-0.5_thin-w30.vcf.gz"

Create stats file for vcf
sbatch -J bcftools --mem 10G -c 1 -N 1 -p ei-short --wrap "source bcftools-1.10.2;bcftools stats Andean_Haplotypecaller_filtered_maxhetero0.2_ID_LD-0.5_thin-w30.vcf.gz > statsAndean_Haplotypecaller_filtered_maxhetero0.2_ID_LD-0.5_thin-w30.txt"

statsAndean_Haplotypecaller_filtered_maxhetero0.2_ID_LD-0.5_thin-30.txt
SN 0 number of samples: 144
SN 0 number of records: 29599

2/ Unzip vcf

sbatch -p ei-long -c 1 -N 1 -J gunzip --wrap "gunzip Andean_Haplotypecaller_filtered_maxhetero0.2_ID_LD-0.5_thin-w30.vcf.gz"


3/ Convert VCF to STRUCTURE format

3.structure_format.sh
sbatch /data/KDJ_scripts/structure_format.sh

4/ Running STRUCTURE

Need mainparams and extraparams file
Edit parameters in mainparams for dataset

sbatch /data/KDJ_scripts/4.structure_array_boilerplate2.sh

Want at least 10 iterations for each KDJ_data

5/ Zip results 

tar -zcvf STRUCTURE_Results.tar.gz Results
tar -xvf STRUCTURE_Results.tar.gz

for ((K=2; K<=10; K+=1));
do
mkdir K${K}
mv Results/K${K}_R* K${K}
done

6/ Futher analysis 

Can have a quick look using structure harvester - folder with all replicates for a k
http://taylor0.biology.ucla.edu/structureHarvester/


7/ Move to R 

Run pophelper in R to align the samples and clumpp to merge them 
7.Pophelper_STRUCTURE.R

8/ To find the best K value use the Evanno Method

9/ Can plot PCA from STRUCTURE

8.PCAs-STRUCTURE.R